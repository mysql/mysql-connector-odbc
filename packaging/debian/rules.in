#!/usr/bin/make -f
# Copyright (c) 2014, 2024, Oracle and/or its affiliates.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License, version 2.0, as
# published by the Free Software Foundation.
#
# This program is designed to work with certain software (including
# but not limited to OpenSSL) that is licensed under separate terms, as
# designated in a particular file or component or in included license
# documentation. The authors of MySQL hereby grant you an additional
# permission to link the program and your derivative works with the
# separately licensed software that they have either included with
# the program or referenced in the documentation.
#
# Without limiting anything contained in the foregoing, this file,
# which is part of Connector/ODBC, is also subject to the
# Universal FOSS Exception, version 1.0, a copy of which can be found at
# https://oss.oracle.com/licenses/universal-foss-exception.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# See the GNU General Public License, version 2.0, for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA


# FIXME: should LIB_DIR be the (lagacy?) "/usr/lib/odbc/" or
# the more correct "/usr/lib/mysql-connector-odbc"?

LIB_DIR = /usr/lib/$(DEB_HOST_MULTIARCH)/odbc
PLUGIN_DIR = /usr/lib/$(DEB_HOST_MULTIARCH)/mysql/libmyodbc@CONNECTOR_MAJOR@/plugin

%:
	dh  $@

CMAKE_OPTS = \
  -DINSTALL_BINDIR=./usr/bin \
	-DINSTALL_LIBDIR=.$(LIB_DIR) \
	-DDEFAULT_PLUGIN_DIR=$(PLUGIN_DIR) \
	-DCMAKE_VERBOSE_MAKEFILE:BOOL=TRUE \
	-DFINDMYSQL_DEBUG:BOOL=TRUE \
	-DMYSQLCLIENT_STATIC_LINKING:BOOL=TRUE  \
	-DBUNDLE_DEPENDENCIES=TRUE \
	-DMYSQL_CXX_LINKAGE=1 \
	-DEXTRA_MYSQL_DEP='z' \
	-DWITH_UNIXODBC=1 @ODBC_OPTS@

override_dh_auto_configure:

	mkdir -p debian/build
	@echo "cmake config options: $(CMAKE_OPTS)"
	cmake -Bdebian/build -S. -G 'Unix Makefiles' $(CMAKE_OPTS) -DCMAKE_BUILD_TYPE=RelWithDebInfo
	# touch $@

override_dh_auto_build:

	#	TODO: DEB_BUILD_HARDENING=1?
	cmake --build debian/build --verbose
	# touch $@


# Do nothing; the test suite requires a sql server, so we can't run it
# as part of the build.
override_dh_auto_test:


TMP_INSTDIR = $(CURDIR)/debian/tmp

override_dh_auto_install:
	install -d -m 0755 $(TMP_INSTDIR)$(LIB_DIR)
	cmake --install debian/build --prefix $(TMP_INSTDIR)

	install -d -m 0755 $(TMP_INSTDIR)$(PLUGIN_DIR)
	mv -v $(TMP_INSTDIR)$(LIB_DIR)/plugin/* $(TMP_INSTDIR)$(PLUGIN_DIR)/
	# Note: Remove custom RPATH in plugins -- we want them to use OS-wide dependencies
	chrpath --delete $(TMP_INSTDIR)$(PLUGIN_DIR)/*
	rm -rf $(TMP_INSTDIR)$(LIB_DIR)/plugin
	rm -rf $(TMP_INSTDIR)$(LIB_DIR)/private


# Note: Exclude plugins from calculating package dependencies

override_dh_shlibdeps:
	dh_shlibdeps -Xmysql_native_password -Xauthentication_
